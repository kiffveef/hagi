#!/bin/bash

# Layer 2: Block .claude/ files from being committed
# This is a backup defense - primary defense is Claude Code PreToolUse hook
CLAUDE_FILES=$(git diff --cached --name-only | grep "^\.claude/")
if [ -n "$CLAUDE_FILES" ]; then
    echo ""
    echo "‚ùå ERROR: .claude/ files should not be committed!"
    echo ""
    echo "üìñ See: .claude/instructions/git-workflow.md"
    echo "   Section: '.claude/ Directory is OUTSIDE Git Workflow'"
    echo ""
    echo ".claude/ is managed separately via 'hagi sync', not git."
    echo "Your edits are already saved locally. No commit needed."
    echo ""
    echo "To unstage these files:"
    echo "  git restore --staged .claude/"
    echo ""
    exit 1
fi

# Check if committing to protected branches
# To add more protected branches, add them to the condition below:
# if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ] || [ "$BRANCH" = "custom" ]; then
BRANCH=$(git branch --show-current)

if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
    echo "‚ùå ERROR: Direct commits to '$BRANCH' branch are not allowed!"
    echo ""
    echo "Please create a feature branch first:"
    echo "  git checkout -b feature/your-feature-name"
    echo ""
    echo "Or move your changes to a new branch:"
    echo "  git checkout -b feature/your-feature-name"
    echo "  git branch -D $BRANCH  # (after confirming the new branch)"
    echo ""
    exit 1
fi

exit 0
